<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CSV Viewer and Converter</title>
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.dataTables.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.7.1/css/buttons.dataTables.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/datatables.net-colresize-unofficial@latest/jquery.dataTables.colResize.css">
  <link rel="stylesheet" type="text/css" href="https://editor.datatables.net/extensions/Editor/css/editor.dataTables.min.css">
  <script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>
  <script type="text/javascript" charset="utf8" src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/1.7.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/1.7.1/js/buttons.colVis.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/1.7.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/datatables.net-colresize-unofficial@latest/jquery.dataTables.colResize.js"></script>
  <script src="https://editor.datatables.net/extensions/Editor/js/dataTables.editor.min.js"></script>
</head>
<body>
  <h1 id="title" style="text-align:center">CSV Viewer and Editor</h1>
  <h2 id="subtitle" style="text-align:center">SAVE TO CSV, EXCEL, JSON</h2>
  <div style="text-align: center;">
    <div>
      <label id="encodingLabel" for="encodingSelect">Encoding</label>
      <select id="encodingSelect">
        <option value="UTF-8">UTF-8</option>
        <option value="UTF-16">UTF-16</option>
        <option value="ISO-8859-1">ISO-8859-1</option>
        <option value="windows-1252">Windows-1252</option>
        <option value="EUC-KR">한글</option>
        <option value="shift-jis">日本語</option>
        <option value="gb2312">中文</option>
      </select>
    </div>
    <div>
      <input type="file" id="csvFileInput" accept=".csv" onchange="handleFileUpload(event)">
    </div>
  </div>

  <table id="myTable" class="display">
    <thead>
    </thead>
    <tbody>
    </tbody>
  </table>

  <script> 
    var dataTable;

    function handleFileUpload(event) {
      var fileInput = event.target;

      var selectedEncoding = document.getElementById('encodingSelect').value;

      if (fileInput.files.length > 0) {
        var file = fileInput.files[0];

        var reader = new FileReader();
        reader.onload = function(e) {
          var csvContent = e.target.result;
          csvContent = csvContent.replace(/\s+$/, '');
          processCSV(csvContent);
        };
        reader.readAsText(file, selectedEncoding);
        document.getElementById('title').remove();
        document.getElementById('subtitle').remove();
        document.getElementById('csvFileInput').remove();
        document.getElementById('encodingLabel').remove();
        document.getElementById('encodingSelect').remove();
      } else {
        alert("Please select a CSV file.");
      }
    }

    function processCSV(csvContent) {
      Papa.parse(csvContent, {
        header: true,
        dynamicTyping: true,
        complete: function(results) {
          var columns =  Object.keys(results.data[0]).map(function(key) {
            return { data: key, title: key };
          });
          columns.unshift({ data: '', title: 'index', mData: '', sTitle: 'index', defaultContent: ''})
          dataTable = $('#myTable').DataTable({
            data: results.data,
            responsive: true,
            columns: columns,
            scrollX: true,
            dom: 'Blfrtip',
            select: true,
            buttons: [
              'colvis',
              {
                extend: 'csv',
                text: 'CSV',
                exportOptions: {
                  columns: ':visible'
                }
              },
              {
                extend: 'excel',
                text: 'EXCEL',
                exportOptions: {
                  columns: ':visible'
                }
              },
              {
                extend: 'pdf',
                text: 'PDF',
                exportOptions: {
                  columns: ':visible'
                }
              },
              {
                text: 'JSON',
                action: function ( e, dt, button, config ) {
                    var data = dt.buttons.exportData();

                    $.fn.dataTable.fileSave(
                        new Blob( [ JSON.stringify( data ) ] ),
                        'Export.json'
                    );
                }
              }
            ],
            colResize: {
              isEnabled: true,
              saveState: true
            },
          });
          dataTable.on('order.dt search.dt', function () {
            dataTable.column(0, {search:'applied', order:'applied'}).nodes().each(function (cell, i) {
                cell.innerHTML = i + 1;
            });
          }).draw();
          dataTable.on('draw.dt', function () {
            dataTable.column(0, {search:'applied', order:'applied'}).nodes().each(function (cell, i) {
              cell.innerHTML = i + 1;
            });
          }).draw();
        }
      });
    }
  </script>
</body>
</html>