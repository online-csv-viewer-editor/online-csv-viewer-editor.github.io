<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DataTables CSV Example</title>
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.dataTables.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.7.1/css/buttons.dataTables.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/datatables.net-colresize-unofficial@latest/jquery.dataTables.colResize.css">
  <script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>
  <script type="text/javascript" charset="utf8" src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/1.7.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/1.7.1/js/buttons.colVis.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/1.7.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/datatables.net-colresize-unofficial@latest/jquery.dataTables.colResize.js"></script>
</head>
<body>
  <input type="file" id="csvFileInput" accept=".csv" onchange="handleFileUpload(event)">
  <label id="encodingLabel" for="encodingSelect">Encoding</label>
  <select id="encodingSelect">
    <option value="UTF-8">UTF-8</option>
    <option value="EUC-KR">한글</option>
    <option value="euc-jp">Japanese</option>
    <option value="UTF-16">UTF-16</option>
    <option value="ISO-8859-1">ISO-8859-1</option>
    <option value="ISO-8859-15">ISO-8859-15</option>
    <option value="windows-1252">Windows-1252</option>
    <option value="shift-jis">Shift JIS</option>
    <option value="gb2312">GB2312</option>
    <option value="gbk">GBK</option>
    <option value="big5">Big5</option>
    <option value="koi8-r">KOI8-R</option>
  </select>

  <table id="myTable" class="display">
    <thead>
    </thead>
    <tbody>
    </tbody>
  </table>

  <script> 
    var dataTable;

    function handleFileUpload(event) {
      var fileInput = event.target;

      var selectedEncoding = document.getElementById('encodingSelect').value;

      if (fileInput.files.length > 0) {
        var file = fileInput.files[0];

        var reader = new FileReader();
        reader.onload = function(e) {
          var csvContent = e.target.result;
          csvContent = csvContent.replace(/\s+$/, '');
          processCSV(csvContent);
          $('#myTable th').resizable({
            handles: 'e',
            stop: function (event, ui) {
              var columnIndex = $(this).index();
              var newWidth = ui.size.width;

              dataTable.column(columnIndex).nodes().to$().width(newWidth);
            }
          });          
        };
        reader.readAsText(file, selectedEncoding);
        document.getElementById('csvFileInput').remove();
        document.getElementById('encodingLabel').remove();
        document.getElementById('encodingSelect').remove();
      } else {
        alert("Please select a CSV file.");
      }
    }

    function processCSV(csvContent) {
      Papa.parse(csvContent, {
        header: true,
        dynamicTyping: true,
        complete: function(results) {
          var columns =  Object.keys(results.data[0]).map(function(key) {
            return { data: key, title: key };
          });
          columns.unshift({ data: '', title: 'index', mData: '', sTitle: 'index', defaultContent: ''})
          dataTable = $('#myTable').DataTable({
            data: results.data,
            responsive: true,
            columns: columns,
            scrollX: true,
            dom: 'Bfrtip',
            buttons: [
                'colvis',
                {
                  extend: 'csv',
                  text: 'Download csv',
                  exportOptions: {
                    columns: ':visible'
                  }
                },
                {
                  extend: 'excel',
                  text: 'Download excel',
                  exportOptions: {
                    columns: ':visible'
                  }
                },
            ],
            colResize: {
              isEnabled: true,
              saveState: true
            }
          });
          console.log(columns);
          dataTable.on('order.dt search.dt', function () {
            dataTable.column(0, {search:'applied', order:'applied'}).nodes().each(function (cell, i) {
                cell.innerHTML = i + 1;
            });
          }).draw();
          dataTable.on('draw.dt', function () {
            dataTable.column(0, {search:'applied', order:'applied'}).nodes().each(function (cell, i) {
              cell.innerHTML = i + 1;
            });
          }).draw();
        }
      });
    }
  </script>
</body>
</html>